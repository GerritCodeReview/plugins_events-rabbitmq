{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "b4393d10_e8d7e3ad",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/rabbitmq/message/BrokerApiSubscribers.java",
        "patchSetId": 14
      },
      "lineNbr": 0,
      "author": {
        "id": 1014252
      },
      "writtenOn": "2025-10-07T06:06:38Z",
      "side": 1,
      "message": "If we cannot differentiate between the separate consumers of a topic and we can only replay for *all* consumers.\nI suggest responding with the offset of the consumer",
      "revId": "c9edecf95095dbaab8abf9e08d9d851664e4efbe",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3e4bb4a3_e17f1209",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/rabbitmq/message/BrokerApiSubscribers.java",
        "patchSetId": 14
      },
      "lineNbr": 0,
      "author": {
        "id": 1135623
      },
      "writtenOn": "2025-10-07T11:10:01Z",
      "side": 1,
      "message": "There is a bunch of offsets(current, stored, the one we replay from, ...).\nCurrently GET return the current offset for each consumer and the replay return the offset to play from(so if 3 is returned then the plugin will start to process 4(except in the case for the start of the stream, in that case if 0 is returned then 0 is processed(I will document that behavior))).\nIs those return values satisfactory?",
      "parentUuid": "b4393d10_e8d7e3ad",
      "revId": "c9edecf95095dbaab8abf9e08d9d851664e4efbe",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7785b08e_28bfce0b",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/rabbitmq/message/BrokerApiSubscribers.java",
        "patchSetId": 14
      },
      "lineNbr": 0,
      "author": {
        "id": 1135623
      },
      "writtenOn": "2025-10-31T12:16:34Z",
      "side": 1,
      "message": "I have now documented the special behavior with offset 0.",
      "parentUuid": "3e4bb4a3_e17f1209",
      "revId": "c9edecf95095dbaab8abf9e08d9d851664e4efbe",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "cea219ea_f023db6d",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/rabbitmq/message/BrokerApiSubscribers.java",
        "patchSetId": 14
      },
      "lineNbr": 0,
      "author": {
        "id": 1135623
      },
      "writtenOn": "2025-11-07T08:03:44Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "7785b08e_28bfce0b",
      "revId": "c9edecf95095dbaab8abf9e08d9d851664e4efbe",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "62119ec7_e1b770e1",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/rabbitmq/session/type/StreamSubscriberSession.java",
        "patchSetId": 14
      },
      "lineNbr": 219,
      "author": {
        "id": 1071857
      },
      "writtenOn": "2025-10-01T09:57:16Z",
      "side": 1,
      "message": "Nit: We could probably look at using something better than a constant check\n```\nwhile(!run)\n;\n```\nMaybe a sleep to avoid constant checking, or some type of await mechanism.\nThe downside is probably more error handling, and the upside is probably minimal.\n\nThis should only live for a very short time, so I don\u0027t know if it matters.\nFeel free to just ack this and move along.",
      "range": {
        "startLine": 218,
        "startChar": 0,
        "endLine": 219,
        "endChar": 9
      },
      "revId": "c9edecf95095dbaab8abf9e08d9d851664e4efbe",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "4f7f0afa_91363853",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/rabbitmq/session/type/StreamSubscriberSession.java",
        "patchSetId": 14
      },
      "lineNbr": 219,
      "author": {
        "id": 1135623
      },
      "writtenOn": "2025-10-02T09:08:11Z",
      "side": 1,
      "message": "If not something really unexpected happens. The wait should be very minimal, likely sub ms, so I felt this was ok. So I stick with it if no one have a good reason it should not be like this.",
      "parentUuid": "62119ec7_e1b770e1",
      "range": {
        "startLine": 218,
        "startChar": 0,
        "endLine": 219,
        "endChar": 9
      },
      "revId": "c9edecf95095dbaab8abf9e08d9d851664e4efbe",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e290f7c0_9e1cf552",
        "filename": "src/main/resources/Documentation/rest-api-topics-offsets-get.md",
        "patchSetId": 14
      },
      "lineNbr": 43,
      "author": {
        "id": 1071857
      },
      "writtenOn": "2025-10-01T09:57:16Z",
      "side": 1,
      "message": "I think it would be nice if we could make this more detailed, but I think it means a pretty significant change and is probably better as an improvement. The only additional information we have directly available are the UUIDs and those aren\u0027t super useful. Feel free to just ack this and move along.\n\n```\n{\n  \"topic\": \"gerrit\",\n  \"consumers\": [\n    {\n      \"consumerId\": \"uuid-1\",\n      \"consumerName\": \"consumer.gerrit.instance-1\", \n      \"currentOffset\": 162,\n      \"lastUpdated\": \"2025-10-01T10:30:00Z\",\n    },\n    {\n      \"consumerId\": \"uuid-2\", \n      \"consumerName\": \"consumer.gerrit.instance-2\",\n      \"currentOffset\": 158,\n      \"lastUpdated\": \"2025-10-01T10:29:55Z\", \n    }\n  ],\n  \"streamInfo\": {\n    \"totalMessages\": 180,\n    \"maxOffset\": 179,\n  }\n}\n```",
      "range": {
        "startLine": 41,
        "startChar": 0,
        "endLine": 43,
        "endChar": 1
      },
      "revId": "c9edecf95095dbaab8abf9e08d9d851664e4efbe",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "855d9c2d_18752bf3",
        "filename": "src/main/resources/Documentation/rest-api-topics-offsets-get.md",
        "patchSetId": 14
      },
      "lineNbr": 43,
      "author": {
        "id": 1135623
      },
      "writtenOn": "2025-10-02T09:08:11Z",
      "side": 1,
      "message": "As I said in a comment response to Sven consumerID is just an UUID generated internally to keep track of things, so it does not say much. consumerName is just consumerPrefix + topic, so it should be the same for all entries if there is several entries. In a ordinary multi-site setup only one entry should be returned.\nlastUpdated could be useful and should probably not require much extra code. Will try to implement it.\n\nGetting the streamInfo data would be a bigger change and unsure how useful it would be. This data should be accessible from RabbitMQ directly.",
      "parentUuid": "e290f7c0_9e1cf552",
      "range": {
        "startLine": 41,
        "startChar": 0,
        "endLine": 43,
        "endChar": 1
      },
      "revId": "c9edecf95095dbaab8abf9e08d9d851664e4efbe",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "dc4c3c48_75629b51",
        "filename": "src/main/resources/Documentation/rest-api-topics-offsets-get.md",
        "patchSetId": 14
      },
      "lineNbr": 43,
      "author": {
        "id": 1014252
      },
      "writtenOn": "2025-10-06T14:08:29Z",
      "side": 1,
      "message": "Why is it a list if there will ever only be one entry?\nI like Rikard\u0027s idea since it makes the information useful.",
      "parentUuid": "855d9c2d_18752bf3",
      "range": {
        "startLine": 41,
        "startChar": 0,
        "endLine": 43,
        "endChar": 1
      },
      "revId": "c9edecf95095dbaab8abf9e08d9d851664e4efbe",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b411a533_80dd1d19",
        "filename": "src/main/resources/Documentation/rest-api-topics-offsets-get.md",
        "patchSetId": 14
      },
      "lineNbr": 43,
      "author": {
        "id": 1135623
      },
      "writtenOn": "2025-10-06T14:53:20Z",
      "side": 1,
      "message": "We have encountered situations when we got duplicate consumers when there should not be. Fortunately, it has not negatively affected our multi-site setup. One of the consumers is just inactive and the other consume like usually.",
      "parentUuid": "dc4c3c48_75629b51",
      "range": {
        "startLine": 41,
        "startChar": 0,
        "endLine": 43,
        "endChar": 1
      },
      "revId": "c9edecf95095dbaab8abf9e08d9d851664e4efbe",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "311c0a3b_10ec40da",
        "filename": "src/main/resources/Documentation/rest-api-topics-offsets-get.md",
        "patchSetId": 14
      },
      "lineNbr": 43,
      "author": {
        "id": 1014252
      },
      "writtenOn": "2025-10-07T06:06:38Z",
      "side": 1,
      "message": "I like Rikard\u0027s Idea of output since it gives the caller a lot more information to go on.\nIf not it will only ever be the offset of the consumer that is most behind that is interesting, as you would need to use that for replay to ensure all consumers are up-to-date, and in that case the response should just be the most outdated offset and not a list.",
      "parentUuid": "b411a533_80dd1d19",
      "range": {
        "startLine": 41,
        "startChar": 0,
        "endLine": 43,
        "endChar": 1
      },
      "revId": "c9edecf95095dbaab8abf9e08d9d851664e4efbe",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "25d852ad_41ff9c69",
        "filename": "src/main/resources/Documentation/rest-api-topics-offsets-get.md",
        "patchSetId": 14
      },
      "lineNbr": 43,
      "author": {
        "id": 1135623
      },
      "writtenOn": "2025-10-07T11:10:01Z",
      "side": 1,
      "message": "Here is some more background info that might clarify things: We name the consumers that we create consumerPrefix + topic. This is done to be able to store offsets consumed periodically in case of failure. The stream lib use the consumerName to be able to retrieve the stored offset. ConsumerPrefix is globally configured value which means that each time we try to add a consumer for a topic \"abc\" with the Broker API it will try to create consumer called consumerPrefix + \"abc\". This is why we only expect one consumer per topic and why the implementation should only work with one consumer per topic. There is documentation/comments for the Broker API that suggest that it should be able to serve arbitrary number of consumers per topic but we have not found a good solution for that.\n\nBecause of a bug we get several consumers per topic sometimes. The extra consumers is inactive so maybe you could call them ghost consumers. The active consumer is the interesting one and will likely have a higher offset for active streams but to be safe I feel like it is better to return all the offsets and replay all the consumers just in case.\n\nThe current stream lib is very limited when it comes to getting metrics. So I would say streamInfo is out of scope for this change at least.",
      "parentUuid": "311c0a3b_10ec40da",
      "range": {
        "startLine": 41,
        "startChar": 0,
        "endLine": 43,
        "endChar": 1
      },
      "revId": "c9edecf95095dbaab8abf9e08d9d851664e4efbe",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3ee7a9c0_e5e1f878",
        "filename": "src/main/resources/Documentation/rest-api-topics-offsets-get.md",
        "patchSetId": 14
      },
      "lineNbr": 43,
      "author": {
        "id": 1135623
      },
      "writtenOn": "2025-10-07T14:47:44Z",
      "side": 1,
      "message": "I added the last_updated field",
      "parentUuid": "25d852ad_41ff9c69",
      "range": {
        "startLine": 41,
        "startChar": 0,
        "endLine": 43,
        "endChar": 1
      },
      "revId": "c9edecf95095dbaab8abf9e08d9d851664e4efbe",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "58cca999_af32521e",
        "filename": "src/main/resources/Documentation/rest-api-topics-offsets-get.md",
        "patchSetId": 14
      },
      "lineNbr": 43,
      "author": {
        "id": 1135623
      },
      "writtenOn": "2025-11-07T08:03:44Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "3ee7a9c0_e5e1f878",
      "range": {
        "startLine": 41,
        "startChar": 0,
        "endLine": 43,
        "endChar": 1
      },
      "revId": "c9edecf95095dbaab8abf9e08d9d851664e4efbe",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}